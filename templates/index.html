<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="3600">
    <title>BRIEF | Your AI News Assistant</title>
    <meta name="description" content="AI-curated news briefings, personalized and delivered with style.">
    <link rel="stylesheet" href="static/css/brief.css">
    <meta name="generated-at" content="{{ generated_utc }}">
    <meta name="duration-en" content="{{ duration }}">
    <meta name="duration-fr" content="{{ duration_fr }}">
</head>
<body>
    <!-- Sticky Player (hidden by default, shows on scroll) -->
    <div class="sticky-player">
        <span class="logo">BRIEF</span>
        <div class="sticky-waveform"></div>
        <button class="sticky-play-btn" aria-label="Play/Pause">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <span class="sticky-time">0:00 / 0:00</span>
        <div class="sticky-progress">
            <div class="sticky-progress-fill"></div>
        </div>
        <button class="sticky-speed">1x</button>
    </div>

    <!-- Pipeline progress bar -->
    <div class="pipeline-progress" id="pipelineProgress">
        <div class="pipeline-progress-fill" id="pipelineProgressFill"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <span class="logo">BRIEF</span>
        <nav class="header-nav">
            <a href="about.html">How it works</a>
            <a href="archive/">Archive</a>
            <a href="#" id="refreshBtn" class="refresh-link" title="Fetch fresh news">
                <svg class="refresh-icon" viewBox="0 0 24 24" width="14" height="14"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </a>
            <span id="refreshStatus" class="refresh-status"></span>
        </nav>
    </header>

    <!-- Stale content warning (shown by JS when brief is old) -->
    <div id="staleBanner" class="stale-banner" style="display:none">
        <span id="staleText"></span>
        <a href="#" id="refreshStale" class="stale-refresh">Refresh now</a>
    </div>

    <!-- Hero Section -->
    <section class="hero">
        <h1 class="greeting" id="greeting">Good morning, sir.</h1>
        <p class="greeting-sub" id="greetingSub">Your briefing is ready.</p>

        <div class="waveform-container" aria-hidden="true"></div>

        <button class="play-btn" id="playBtn">
            <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg class="stop-icon" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"/></svg>
            <span>Play Briefing</span>
        </button>

        {% if audio_file_fr %}
        <div class="lang-toggle">
            <button class="lang-btn active" data-lang="en">EN</button>
            <span class="lang-divider">/</span>
            <button class="lang-btn" data-lang="fr">FR</button>
        </div>
        {% endif %}

        <p class="brief-meta">
            {{ date_display }}<span>&middot;</span>{{ article_count }} stories<span>&middot;</span><span id="audioDuration">{{ duration }}</span>
        </p>

        <div class="playback-controls">
            <button class="skip-btn skip-back" aria-label="Back 15 seconds">
                <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/><text x="12" y="15" font-size="7" text-anchor="middle">15</text></svg>
            </button>
            <span class="time-display">0:00 / 0:00</span>
            <button class="skip-btn skip-forward" aria-label="Forward 15 seconds">
                <svg viewBox="0 0 24 24"><path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z"/><text x="12" y="15" font-size="7" text-anchor="middle">15</text></svg>
            </button>
            <button class="speed-btn">1x</button>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill"></div>
                <div class="progress-handle"></div>
            </div>
        </div>

        <a href="#stories" class="scroll-hint">
            <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            Explore today's stories
        </a>
    </section>

    <!-- Audio Element -->
    {% if audio_file %}
    <audio id="briefAudio" preload="metadata" crossorigin="anonymous">
        <source src="{{ audio_file }}" type="audio/mpeg">
    </audio>
    {% endif %}

    <!-- Main Content -->
    <main class="content" id="stories">
        {% for section_name, articles in sections.items() %}
        <section class="section">
            <header class="section-header">
                <h2 class="section-title">{{ section_name }}</h2>
                <span class="section-count">{{ articles|length }} stories</span>
            </header>

            {% for item in articles %}
            <article class="article"
                     data-index="{{ loop.index }}"
                     data-hash="{{ item.article.article_hash }}"
                     data-category="{{ item.article.category }}">
                <div class="article-top">
                    <div class="article-source">
                        <div class="reliability-badge {{ 'high' if item.article.reliability >= 0.9 else 'medium' if item.article.reliability >= 0.8 else 'low' }}">
                            {{ '%.0f'|format(item.article.reliability * 100) }}%
                        </div>
                        <span class="source-name">{{ item.article.source }}</span>
                    </div>
                    <span class="article-time">{{ item.article.published.strftime('%-I:%M %p') if item.article.published else '' }}</span>
                </div>

                <h3 class="article-title">
                    <a href="{{ item.article.link }}"
                       target="_blank"
                       rel="noopener"
                       class="article-link-title"
                       data-hash="{{ item.article.article_hash }}">
                        {{ item.article.title }}
                    </a>
                </h3>

                {% if item.ai_summary %}
                <p class="article-summary">{{ item.ai_summary|clean_summary }}</p>
                {% elif item.article.summary %}
                {% set cleaned = item.article.summary|clean_summary %}
                <p class="article-summary">{{ cleaned[:200] }}{% if cleaned|length > 200 %}...{% endif %}</p>
                {% endif %}

                {% if item.why_it_matters %}
                <div class="article-why">
                    {{ item.why_it_matters }}
                </div>
                {% endif %}

                <div class="article-actions">
                    <a href="{{ item.article.link }}"
                       target="_blank"
                       rel="noopener"
                       class="article-link"
                       data-hash="{{ item.article.article_hash }}">
                        Read full article &rarr;
                    </a>

                    <div class="feedback-buttons">
                        <button class="feedback-btn like-btn"
                                data-hash="{{ item.article.article_hash }}"
                                data-category="{{ item.article.category }}"
                                data-action="like"
                                title="More like this">
                            <svg viewBox="0 0 24 24" width="18" height="18">
                                <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
                            </svg>
                        </button>
                        <button class="feedback-btn dislike-btn"
                                data-hash="{{ item.article.article_hash }}"
                                data-category="{{ item.article.category }}"
                                data-action="dislike"
                                title="Less like this">
                            <svg viewBox="0 0 24 24" width="18" height="18">
                                <path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </article>
            {% endfor %}
        </section>
        {% endfor %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p class="footer-meta">
            Curated from 50+ sources &middot; Reliability-scored &middot; Learns your interests &middot; Ad-free
        </p>
        <nav class="footer-links">
            <a href="about.html">How it works</a>
            <a href="archive/">Archive</a>
            <a href="https://github.com/axeandlord/news">Source</a>
            <a href="#" id="exportFeedback" style="display:none">Export Feedback</a>
        </nav>
    </footer>

    <script src="static/js/greeting.js"></script>
    <script src="static/js/player.js"></script>
    <script src="static/js/feedback.js"></script>
    <script src="static/js/refresh.js"></script>
    <script>
    // Language toggle for EN/FR audio
    (function() {
        var toggle = document.querySelector('.lang-toggle');
        if (!toggle) return;
        var audio = document.getElementById('briefAudio');
        if (!audio) return;

        var srcEn = '{{ audio_file }}';
        var srcFr = '{{ audio_file_fr }}';
        var durEn = (document.querySelector('meta[name="duration-en"]') || {}).content || '';
        var durFr = (document.querySelector('meta[name="duration-fr"]') || {}).content || '';
        var durSpan = document.getElementById('audioDuration');

        toggle.addEventListener('click', function(e) {
            var btn = e.target.closest('.lang-btn');
            if (!btn || btn.classList.contains('active')) return;

            toggle.querySelectorAll('.lang-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');

            var lang = btn.dataset.lang;
            var player = window.briefPlayer;

            // Stop current playback
            audio.pause();
            audio.currentTime = 0;
            if (player) {
                player.isPlaying = false;
                player.playBtn.classList.remove('playing');
                player.checkedAnalyser = false;
                player.analyserWorking = false;
            }

            // Swap source on same element (preserves Web Audio connection)
            audio.src = lang === 'fr' ? srcFr : srcEn;
            audio.load();

            if (durSpan) durSpan.textContent = lang === 'fr' ? durFr : durEn;
            if (player) {
                player.updateTimeDisplay();
                player.drawIdleWaveform();
            }
        });
    })();
    </script>
    <script>
    (function() {
        var meta = document.querySelector('meta[name="generated-at"]');
        if (!meta) return;
        var generated = new Date(meta.content);
        var hours = (Date.now() - generated.getTime()) / 3600000;
        if (hours < 8) return;
        var text = hours < 24
            ? 'This briefing is ' + Math.round(hours) + ' hours old.'
            : 'This briefing is ' + Math.round(hours / 24) + ' day' + (Math.round(hours / 24) > 1 ? 's' : '') + ' old.';
        document.getElementById('staleText').textContent = text;
        document.getElementById('staleBanner').style.display = '';
        var btn = document.getElementById('refreshStale');
        if (btn) btn.addEventListener('click', function(e) {
            e.preventDefault();
            var r = document.getElementById('refreshBtn');
            if (r) r.click();
        });
    })();
    </script>
</body>
</html>
